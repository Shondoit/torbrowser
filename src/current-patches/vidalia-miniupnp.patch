Index: INSTALL
===================================================================
--- INSTALL	(revision 2465)
+++ INSTALL	(working copy)
@@ -206,3 +206,8 @@
 'cmake --help' or 'man cmake' (on non-Windows platforms) for more information
 about supported generators and configuration options.
 
+Including UPnP support
+----------------------
+
+cmake -G "MSYS Makefiles" -DMINIUPNPC_LIBRARY_DIR="/usr/local/lib" -DMINIUPNPC_INCLUDE_DIR="/usr/local/include" .
+
Index: src/vidalia/CMakeLists.txt
===================================================================
--- src/vidalia/CMakeLists.txt	(revision 2473)
+++ src/vidalia/CMakeLists.txt	(working copy)
@@ -16,6 +16,7 @@
   ${CMAKE_CURRENT_SOURCE_DIR}
   ${CMAKE_CURRENT_SOURCE_DIR}/config
   ${CMAKE_CURRENT_SOURCE_DIR}/help/browser
+  ${MINIUPNPC_INCLUDE_DIR}
 )
 configure_file(
   ${CMAKE_CURRENT_SOURCE_DIR}/res/vidalia_win.rc.in
@@ -61,6 +62,7 @@
   config/portvalidator.cpp
   config/serverpage.cpp
   config/serversettings.cpp
+  config/upnpcontrol.cpp
   config/torsettings.cpp
   config/vidaliasettings.cpp
   config/vsettings.cpp
@@ -80,6 +82,7 @@
   config/portvalidator.h
   config/serverpage.h
   config/serversettings.h
+  config/upnpcontrol.h
   config/torsettings.h
   config/vidaliasettings.h
   config/vsettings.h
@@ -234,9 +237,16 @@
 endif(APPLE)
 add_dependencies(${vidalia_BIN} translations)
 
+## Link in miniupnpc
+find_library(MINIUPNPC
+    NAMES miniupnpc
+    PATHS ${MINIUPNPC_LIBRARY_DIR}
+)
+
 ## Link to the Qt libraries and other libraries built as a part of Vidalia
 target_link_libraries(${vidalia_BIN}
   ${QT_LIBRARIES}
+  ${MINIUPNPC}
   torcontrol
   util
 )
Index: src/vidalia/config/serversettings.cpp
===================================================================
--- src/vidalia/config/serversettings.cpp	(revision 2473)
+++ src/vidalia/config/serversettings.cpp	(working copy)
@@ -20,6 +20,7 @@
 
 #include "serversettings.h"
 #include "torsettings.h"
+#include "upnpcontrol.h"
 
 /** Define the set of characters that are valid in a nickname. */
 #define VALID_NICKNAME_CHARS \
@@ -130,6 +131,9 @@
   bool rc;
 
   if (isServerEnabled()) {
+    /* Configure UPnP device to forward DirPort and OrPort */
+    /* TODO: does isServerEnabled() return true when a server is just set up? */
+    configurePortForwarding();
     rc = torControl()->setConf(confValues(), errmsg);
   } else { 
     QStringList resetKeys;
@@ -152,6 +156,17 @@
   return rc;
 }
 
+/* TODO: We should call this periodically, in case the router gets rebooted or forgets its UPnP settings */
+/* TODO: Remove port forwarding when Tor is shutdown or the ORPort changes */
+/* TODO: init_upnp() will block for up to 2 seconds. We should fire off a thread */
+/** Configure UPnP device to forward DirPort and ORPort */
+void
+ServerSettings::configurePortForwarding()
+{
+  UPNPControl *pUNPControl = UPNPControl::Instance();
+  pUNPControl->forwardPort(getORPort());
+}
+
 /** Virtual method called when we retrieve a server-related setting from Tor.
  * Currently this just translates BandwidthFoo to RelayBandwidthFoo when
  * appropriate. */
Index: src/vidalia/config/serversettings.h
===================================================================
--- src/vidalia/config/serversettings.h	(revision 2473)
+++ src/vidalia/config/serversettings.h	(working copy)
@@ -91,6 +91,9 @@
 private:
   /** Returns Tor-recognizable configuration keys and current values. */
   QHash<QString,QString> confValues();
+
+  /** Configure UPnP device to forward DirPort and ORPort */
+  void configurePortForwarding();
 };
 
 #endif
Index: src/vidalia/config/upnpcontrol.cpp
===================================================================
--- src/vidalia/config/upnpcontrol.cpp	(revision 0)
+++ src/vidalia/config/upnpcontrol.cpp	(revision 0)
@@ -0,0 +1,129 @@
+/*
+**  This file is part of Vidalia, and is subject to the license terms in the
+**  LICENSE file, found in the top level directory of this distribution. If 
+**  you did not receive the LICENSE file with this file, you may obtain it
+**  from the Vidalia source package distributed by the Vidalia Project at
+**  http://www.vidalia-project.net/. No part of Vidalia, including this file,
+**  may be copied, modified, propagated, or distributed except according to
+**  the terms described in the LICENSE file.
+*/
+
+/* 
+** \file upnpcontrol.cpp
+** \version $Id: torcontrol.h 2362 2008-02-29 04:30:11Z edmanm $
+** \brief Singleton object for interacting with UPNP device
+*/
+
+#include "upnpcontrol.h"
+
+UPNPControl* UPNPControl::pInstance = 0;
+UPNPControl* UPNPControl::Instance()
+{
+  if (0 == pInstance)
+    pInstance = new UPNPControl;
+  return pInstance;
+}
+
+UPNPControl::UPNPControl()
+{
+  init_upnp();
+}
+
+int
+UPNPControl::forwardPort(quint16 port)
+{
+  int retval;
+  
+  char sPort[6];
+  
+  char intClient[16];
+  char intPort[6];
+
+  // Convert the port number to a string
+  snprintf(sPort, sizeof(sPort), "%d", port);
+
+  // Add the port mapping of external:port -> internal:port
+  retval = UPNP_AddPortMapping(urls.controlURL, data.servicetype,
+			       sPort, sPort, lanaddr, "Tor server", "TCP");
+  if(UPNPCOMMAND_SUCCESS != retval) {
+    printf("AddPortMapping(%s, %s, %s) failed with code %d\n",
+	   sPort, sPort, lanaddr, retval);
+    return 1;
+  }
+  
+  // Check if the port mapping was accepted
+  retval = UPNP_GetSpecificPortMappingEntry(urls.controlURL,
+					    data.servicetype,
+					    sPort, "TCP",
+					    intClient, intPort);
+  if(UPNPCOMMAND_SUCCESS != retval) {
+    printf("GetSpecificPortMappingEntry() failed with code %d\n", retval);
+    return 2;
+  }
+  
+  if(! intClient[0]) {
+    printf("GetSpecificPortMappingEntry failed.\n");
+    return 3;
+  }
+  
+  // Output the mapping
+  printf("(external):%s -> %s:%s\n", sPort, intClient, intPort);
+  return 0;
+}
+
+/** Based on http://miniupnp.free.fr/files/download.php?file=xchat-upnp20061022.patch */
+void
+UPNPControl::init_upnp()
+{
+  struct UPNPDev * devlist;
+  int retval;
+
+  printf("TB : init_upnp()\n");
+
+  memset(&urls, 0, sizeof(struct UPNPUrls));
+  memset(&data, 0, sizeof(struct IGDdatas));
+
+  devlist = upnpDiscover(2000, NULL, NULL);
+  retval = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));
+  printf("UPNP: %d", retval);
+
+  freeUPNPDevlist(devlist);
+}
+
+/** Based on http://miniupnp.free.fr/files/download.php?file=xchat-upnp20061022.patch */
+void
+UPNPControl::upnp_add_redir(const char * addr, int port)
+{
+	char port_str[16];
+	int r;
+	printf("TB : upnp_add_redir (%s, %d)\n", addr, port);
+	if(urls.controlURL[0] == '\0')
+	{
+		printf("TB : the init was not done !\n");
+		fflush(stdout);
+		return;
+	}
+	
+	r = UPNP_AddPortMapping(urls.controlURL, data.servicetype,
+	                        port_str, port_str, addr, 0, "TCP");
+	if(r==0)
+		printf("AddPortMapping(%s, %s, %s) failed\n", port_str, port_str, addr);
+	fflush(stdout);
+}
+
+/** Based on http://miniupnp.free.fr/files/download.php?file=xchat-upnp20061022.patch */
+void
+UPNPControl::upnp_rem_redir(int port)
+{
+	char port_str[16];
+	int t;
+	printf("TB : upnp_rem_redir (%d)\n", port);
+	if(urls.controlURL[0] == '\0')
+	{
+		printf("TB : the init was not done !\n");
+		fflush(stdout);
+		return;
+	}
+	sprintf(port_str, "%d", port);
+	UPNP_DeletePortMapping(urls.controlURL, data.servicetype, port_str, "TCP");
+}
Index: src/vidalia/config/upnpcontrol.h
===================================================================
--- src/vidalia/config/upnpcontrol.h	(revision 0)
+++ src/vidalia/config/upnpcontrol.h	(revision 0)
@@ -0,0 +1,48 @@
+/*
+**  This file is part of Vidalia, and is subject to the license terms in the
+**  LICENSE file, found in the top level directory of this distribution. If 
+**  you did not receive the LICENSE file with this file, you may obtain it
+**  from the Vidalia source package distributed by the Vidalia Project at
+**  http://www.vidalia-project.net/. No part of Vidalia, including this file,
+**  may be copied, modified, propagated, or distributed except according to
+**  the terms described in the LICENSE file.
+*/
+
+/* 
+** \file upnpcontrol.h
+** \version $Id: torcontrol.h 2362 2008-02-29 04:30:11Z edmanm $
+** \brief Singleton object for interacting with UPNP device
+*/
+
+#ifndef _UPNPCONTROL_H
+#define _UPNPCONTROL_H
+
+#include <QObject>
+
+#define STATICLIB
+#include <miniupnpc/miniwget.h>
+#include <miniupnpc/miniupnpc.h>
+#include <miniupnpc/upnpcommands.h>
+
+class UPNPControl : public QObject
+{
+  Q_OBJECT
+
+public:
+  static UPNPControl* Instance();
+  int forwardPort(quint16 port);
+protected:
+  UPNPControl();
+private:
+  static UPNPControl* pInstance;
+
+  /** Used by miniupnpc library */
+  struct UPNPUrls urls;
+  struct IGDdatas data;
+  char lanaddr[16];
+  void init_upnp();
+  void upnp_add_redir (const char * addr, int port);
+  void upnp_rem_redir(int port);
+};
+
+#endif 
