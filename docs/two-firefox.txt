###
### Notes on problems running two Firefox instances in parallel
###
### Steven J. Murdoch <http://www.cl.cam.ac.uk/users/sjm217/>
###
### $Id$
###

Introduction
============

It sometimes might be desirable to have multiple instances of Tor
running simultaneously, for example using one for normal web browsing
and one for Tor.

Firefox does not support this very well, under Windows, and therefore
FirefoxPortable will by default prevent multiple instances of Firefox.

There are two scenarios in which multiple instances of Firefox will
run: Tor Browser starting first and Tor Browser starting second. Since
we only have control of the Tor Browser configuration, the two
scenarios are difference.

Tor Browser starting first
==========================

If Firefox is not running when Tor Browser is started, FirefoxPortable
will launch Firefox as normal.

When the second Firefox is launched, it will search for existing
Firefox windows:
 http://lxr.mozilla.org/mozilla1.8.0/source/xpfe/bootstrap/nsNativeAppSupportWin.cpp#1060

If an existing instance is found, Firefox will open a new Window, so
the end result is two Torifed Firefox windows.

Tor Browser starting second
===========================

If Firefox is already running when Tor Browser is launched,
FirefoxPortable will abort the startup unless the
AllowMultipleInstances FirefoxPortable option is set.

In that case, the MOZ_NO_REMOTE environment variable will be set,
which will cause Firefox not to search for existing Firefox windows,
and so launch a separate instance.

MOZ_NO_REMOTE appears to also disable the creation of a messaging
window, so will also handle the case of Tor Browser starting first. If
this is not the case, an extension to the Torbutton addon can have the
same effect.

Problems with AllowMultipleInstances
====================================

The AllowMultipleInstances option is close to what is needed, but
there are two main problems.

The first problem is that enabling the option will disable some of the
FirefoxPortable cleanup code. From initial tests, this does not appear
to leave any additional traces, but more investigation is needed.

The second, and more serious problem, is that enabling the option
conflicts with WaitForFirefox option. This means that the first time
Tor Browser Bundle is run, FirefoxPortable will open a Firefox window
and exit, causing Vidalia to exit too. This occurs even if
WaitForFirefox is true. When FirefoxPortable is run a second time, it
starts as normal.

This is probably a bug in FirefoxPortable, and needs to be
investigated further. If fixed, it looks likely that it will be
possible to have multiple instances of Firefox
